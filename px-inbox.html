<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. tests, examples), we assume the server is started with
    'gulp serve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="css/px-inbox-styles.html">
<link rel="import" href="../px-dropdown/px-dropdown.html" />
<link rel="import" href="../px-simple-bar-chart/px-simple-bar-chart.html" />
<script src="../moment/moment.js"></script>
<script src="../lodash/lodash.js"></script>
<script src="../moment-duration-format/lib/moment-duration-format.js"></script>

<!--

##### Usage

    <px-inbox height="100vh" list-items='[{"id":"1","title":"GT Vibration","subtitle":"Block 2","severity":"important","date":"2016-10-05T01:29"}]'>
      // define or bind to detail view here
    </px-inbox>

### Styling
The following custom properties are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--px-inbox-border-color` | Border color for list items | `$gray6`
`--px-inbox-secondary-text-color` | Text color for subtitle and date | `$gray6`
`--px-inbox-li-background-color` | Background color for list items | `$gray1`
`--px-inbox-li-background-color--selected` | Background color for selected list item | `$select-blue-default`
`--px-inbox-li-text-color--selected` | Text color for selected list item | `$white`
`--px-inbox-icon-outline-color` | Outline color for all alert icons | `$white`
`--px-inbox-alert-color` | Background color for level 1 alert icons | `$alert-red`
`--px-inbox-warning-color` | Background color for level 2 alert icons | `$alert-orange`
`--px-inbox-error-color` | Background color for level 3 alert icons | `$alert-yellow`
`--px-inbox-information-color` | Background color for level 4 alert icons | `$alert-blue`

@element px-inbox
@blurb A list/detail or "Inbox" view for drilling down on items for more information.
@homepage index.html
@demo index.html
-->

<dom-module id="px-inbox">
  <template>
    <style include="px-inbox-styles"></style>
    <div id="container" class="container flex">
      <div id="list" class="list u-1/6-desk u-1/4-lap">


        <ul class="list-ui list-ui--small">
          <li style="border: 0px; height: 40px;">
            <div class="flex flex--justify">
              <div class="flex flex--left">
                <span class="subtitle" style="color: #8c8c8d; padding-right: 10px">Sort by:</span>
                <template is="dom-if" if="{{!isReverse}}">
                  <span class="subtitle actionable" style="color: #129ec2; padding-right: 5px" on-click="_toggleSort"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></span>
                </template>
                <template is="dom-if" if="{{isReverse}}">
                  <span class="subtitle actionable" style="color: #129ec2; padding-right: 5px" on-click="_toggleSort"><i class="fa fa-arrow-circle-down" aria-hidden="true"></i></span>
                </template>

                <span class="subtitle" style="color:#129ec2">Departure Time</span>
              </div>
              <div class="flex flex--right">
                <span class="fa-stack fa-md">
                  <i class="fa fa-circle-o fa-stack-2x" style="font-size: 1.7rem;"></i>
                  <i class="fa fa-filter fa-stack-1x" style="font-size: 0.8rem; bottom:7;"></i>
                </span>
              </div>
            </div>
          </li>
          <li style="border-top: 0px">
            <div class="flex flex--justify">
              <div class="flex flex--left">
                <div class="disrupted-flight-row flex__item flex__item--bottom">
                  <input class="px-inbox-checkbox" type="checkbox"/>
                </div>
                <div class="text disrupted-flight-row flex__item flex__item--bottom">
                  <button class="btn btn--tertiary">Solve</button>
                </div>
              </div>
              <div class="flex flex--right">
                <div class="text disrupted-flight-row" style="padding-right: 10px">
                  <span class="subtitle legend-text">
                    Terminating
                    <br>
                    Connecting
                    <br>
                    Misconnecting
                  </span>
                </div>
                <div>
                  <px-simple-bar-chart width='10' height='35' chart-data='[[10],[10],[10]]' colors='["#b277b1","#5fa5d8","#61bc68"]' legend-labels='[]' legend-order="reverse"></px-simple-bar-chart>
                </div>
              </div>
            </div>
          </li>
          <template is="dom-repeat" items="{{listItems}}" as="listItem" filter="{{_computeFilter(_query)}}" sort="{{_computeSort(sortBy)}}">
            <li id="{{listItem.id}}" class$="{{_computeClass(selectedItem,listItem.id)}}" on-click="_selectItem">
              <div class="flex flex--justify">
                <div class="flex flex--left">
                  <div class="disrupted-flight-row flex__item flex__item--middle">
                    <input class="px-inbox-checkbox" type="checkbox"/>
                  </div>
                  <div class="text disrupted-flight-row">
                    <span class$="title {{_getColor(listItem)}}" style="text-transform: uppercase">{{listItem.tenant}} {{listItem.flightDetails.flightNumber}}</span>
                    <br/>
                    <span class="subtitle">{{_formatDate(listItem)}}</span>
                  </div>
                  <div class="text disrupted-flight-row">
                    <span class="subtitle">{{_formatStation(listItem.flightDetails.origin)}} - {{_formatStation(listItem.flightDetails.destination)}}</span>
                    <br/>
                    <template is="dom-if" if="{{listItem.disruption.cancel}}">
                      <span class="subtitle">Cancelled</span>
                    </template>
                    <template is="dom-if" if="{{listItem.disruption.delay}}">
                      <span class="subtitle">Delay </span><span class="title">{{_getDuration(listItem.disruption.delay.minutes)}}</span>
                    </template>
                    <br/>
                    <span class="subtitle">Impacted </span><span class="title">{{_formatImpacted(listItem)}}</span>
                  </div>
                </div>
                <div class="flex flex--right">
                  <px-simple-bar-chart width='15' height='55' chart-data='{{_buildChartData(listItem)}}' colors='["#b277b1","#5fa5d8","#61bc68"]' legend-labels='[]' legend-order="reverse"></px-simple-bar-chart>
                </div>
              </div>
            </li>
          </template>
        </ul>
      </div>
      <div id="detail" class="detail u-5/6-desk u-3/4-lap">
        <content></content>
      </div>
    </div>

  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-inbox',

    /**
    * Event that is fired when the selected item is changed in the list component.
    * You should listen for this event and then access selectedItem to get the ID of the item.
    * @event selected-item-changed
    */

    properties: {
      /**
      * Array of items to include in the list. Each item in the array should be an object with:
      * - id (used for fetching the details view)
      * - title
      * - subtitle
      * - severity (one of "important", "error", "warning", or "information")
      * - date (optional, should be valid <a href="https://www.w3.org/TR/NOTE-datetime">8601 date strings</a>)
      * @property listItems
      */
      listItems: {
        type: Array,
        observer: '_formatDates'
      },
      /**
      * ID of the selected item, for pulling up the details to display in the right side of the inbox view.
      * @property selectedItem
      */
      selectedItem: {
        type: String,
        notify: true
      },
      /**
      * Search query used to filter the list.
      * @property _query
      */
      _query: {
        type: String
      },
      /**
      * Property to sort the list by.
      * @property sortBy
      */
      sortBy: {
        type: String,
        value: "Date"
      },
      /**
      * Height to render the inbox view component.
      * @property height
      * @default "100vh"
      */
      height: {
        type: String,
        value: "100vh",
        observer: "_updateHeight"
      },

      selectedItems: {
        type: Array,
        value: function() {
          return [];
        }
      },

      isReverse: {
        type: Boolean,
        value: false,
        notify: true,
        observer: '_sort'
      }
    },

    /**
    * Figures out whether the item is currently selected.
    * @method _computeClass
    */
    _computeClass: function(selectedId, id) {
      return JSON.stringify(selectedId) === JSON.stringify(id) ? 'list-ui__item pointer selected' : 'list-ui__item pointer';
    },

    /**
    * Adds visual style to the currently selected item and triggers display of the details.
    * @method _selectItem
    */
    _selectItem: function(evt) {
      var otherItems = Polymer.dom(this.root).querySelectorAll('.selected');
      for (var i=0; i<otherItems.length; i++) {
        otherItems[i].classList.remove("selected");
      };

      evt.currentTarget.classList.add("selected");
      this.selectedItem = evt.currentTarget.id;
    },
    /**
    * Formats the date strings in each listItem to display correctly in the table using Moment.js.
    * @method _formatDates
    */
    _formatDates: function() {
      for (var i=0; i<this.listItems.length; i++) {
        // If date is defined and recognized as a valid date string, convert to a friendlier display format.
        if(this.listItems[i].date && moment(this.listItems[i].date).isValid()) {
          this.listItems[i].formattedDate = moment(this.listItems[i].date).fromNow();
        }
        // If not recognized as a valid date string, just display whatever was passed in.
        else {
          this.listItems[i].formattedDate = this.listItems[i].date;
        }
      };
      // By default, the first item in the array is selected on load.
      if(this.listItems && this.listItems.length > 0) {
        this.selectedItem = this.listItems[0].id;
      }
    },
    /**
    * Searches through the list titles and subtitles and filters based on the query.
    * @method _computeFilter
    */
    _computeFilter: function(query) {
      // clear all selections
      var otherItems = Polymer.dom(this.root).querySelectorAll('.selected');

      for (var i=0; i<otherItems.length; i++) {
        otherItems[i].classList.remove("selected");
      };
      this.selectedItem = "";

      if (!query) {
        // set filter to null to disable filtering
        return null;
      } else {
        // return a filter function for the current search query
        query = query.toLowerCase();
        return function(listItem) {
          var title = listItem.title.toLowerCase();
          var subtitle = listItem.subtitle.toLowerCase();
          return (title.indexOf(query) != -1 ||
              subtitle.indexOf(query) != -1);
        };
      }
    },
    /**
    * Sort function for the array of list items.
    * @method _computeSort
    */
    _computeSort: function(sortBy) {
      sortBy = sortBy.toLowerCase();
      // clear all selections
      var otherItems = Polymer.dom(this.root).querySelectorAll('.selected')
      for (var i=0; i<otherItems.length; i++) {
        otherItems[i].classList.remove("selected");
      };
      this.selectedItem = "";
      // return sort function which maps severities to numeric values
      if(sortBy === "severity") {
        return function(a, b) {
          var severities = {
            "important":4,
            "warning":3,
            "error":2,
            "information":1
          }
          return severities[b.severity] - severities[a.severity];
        }
      }
      // return sort function which correctly compares dates
      else if (sortBy === "date") {
        return function(a,b) {
          return (a.date > b.date) ? -1 : (a.date < b.date) ? 1 : 0;
        }
      }
      // return sort function which compares the items mathematically
      else {
        return function(a, b) {
          return (a[sortBy] < b[sortBy]) ? -1 : (a[sortBy] > b[sortBy]) ? 1 : 0;
        }
      }
    },
    _updateHeight: function() {
      this.$.container.style.height = this.height;
    },

    _formatDate: function(listItem) {
      var date = listItem.flightDetails.departureTimeEst == null ? null : listItem.flightDetails.departureTimeEst.$date;
      if (date == null || !this._isValidDate(date)) {
        date = listItem.flightDetails.departureTimeSch == null ? null : listItem.flightDetails.departureTimeSch.$date;
      }

      return moment(date).utc().format('HH:mm/DD');
    },

    _formatImpacted: function(listItem) {
      var impactedString = '';
      if (listItem.flightDetails.businessCompartmentPax != null && listItem.flightDetails.businessCompartmentPax > 0) {
          impactedString += "J" + listItem.flightDetails.businessCompartmentPax;
      }

      if (listItem.flightDetails.coachCompartmentPax != null && listItem.flightDetails.coachCompartmentPax > 0) {
        impactedString += "Y" + listItem.flightDetails.coachCompartmentPax;
      }

      return impactedString;
    },

    _getDuration: function(minutes) {
      return moment.duration(minutes, "minutes").format("hh:mm");
    },

    _formatStation: function(station) {
      return station.substr(3, 7);
    },

    _buildChartData: function(listItem) {
      var chartData = [
        [listItem.terminatingPax],
        [listItem.connectingPax],
        [listItem.misconnectingPax]
      ];
      return chartData;
    },
    _isValidDate: function(date) {
      var minDate = moment.utc("0001-01-01");
      return moment.utc(date).isAfter(minDate);
    },
    _getColor: function(listItem) {
      if (listItem.disruption.delay != null) {
        return "delayed";
      }
      else {
        return "cancelled";
      }
    },
    _sort: function() {
      if (this.listItems != null && this.listItems.length > 0) {
        this.listItems = _.orderBy(this.listItems, [
          function (item) { return item.flightDetails.getBestDeptTime(); },
          function (item) { return item.totalImpactedPax; },
          function (item) { return item.flightDetails.businessCompartmentCount; },
          function (item) { return item.flightDetails.flightNumber; }
        ], [this._getOrder(), "asc", "asc", "asc"]);
      }
    },

    _getOrder: function() {
      if (this.isReverse) {
          return "desc";
      }
      return "asc";
    },

    _toggleSort: function() {
      this.isReverse = !this.isReverse;
    },

    _getBestDeptTime: function(listItem) {
      return this._getBestAvailableTime(listItem.flightDetails.departureTimeEst.$date, listItem.flightDetails.departureTimeSch.$date);
    },

    _getBestArrTime: function(listItem) {
      return this._getBestAvailableTime(listItem.flightDetails.arrivalTimeEst.$date, listItem.flightDetails.arrivalTimeSch.$date);
    },

    _getBestAvailableTime: function(estimated, scheduled){
      var bestAvailableTime = estimated;
      if (bestAvailableTime == null || !this._isValidDate(bestAvailableTime)) {
        bestAvailableTime = scheduled;
      }
      return moment(bestAvailableTime).utc().format('HH:mm/DD');
    }
  });
</script>
